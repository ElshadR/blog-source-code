
<div class="paragraph">
<p>AKS (Azure Container Service) is the managed Kubernetes service on <a href="https://docs.microsoft.com/en-us/azure/aks/">Microsoft Azure</a>. It is currently in preview, so there are some things that may change down the road.</p>
</div>
<div class="paragraph">
<p>In this post, I&#8217;m going to create an AKS cluster and install a Couchbase cluster on it, using the <a href="http://docs.couchbase.com/prerelease/couchbase-operator/beta/overview.html">Couchbase Kubernetes operator</a> (which is also in pre-release).</p>
</div>
<div class="paragraph">
<p>This post assumes you&#8217;ve already created an Azure account. If you haven&#8217;t, check out <a href="https://blog.couchbase.com/azure-getting-started-easy-free/">Azure: Getting Started is Easy and Free</a>.</p>
</div>
<div class="sect1">
<h2 id="_azure_cloud_shell">Azure Cloud Shell</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, login to the <a href="https://portal.azure.com/#@">Azure portal</a>. I&#8217;m going to use a relatively new and very cool feature of Azure called the Cloud Shell. Click on the "command prompt" icon at the top right of the Azure portal screen.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10601-azure-cloud-shell-icon.png" alt="Azure Cloud Shell icon" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>Clicking this will open up a shell command prompt window right in your browser. The first time you do this, Azure will be prompt you to decide between Bash and PowerShell. I decided to use PowerShell. <em>(If you are more comfortable with Bash, then you should still be able to follow along)</em>. You will need to setup a storage account the first time (and only the first time) you use the Cloud Shell. This will take several minutes.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10602-bash-or-powershell.png" alt="Bash or PowerShell" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>Once you have a command prompt, you can start typing in commands directly to your browser!</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10603-cloud-azure-prompt.png" alt="Azure Cloud Shell prompt" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>If you&#8217;re like me and have multiple account subscriptions within Azure (for instance, I have an MSDN subscription and a Pay-as-you-go subscription), you should check to see which is the "default" by entering this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>az account list</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will print out a list of your accounts in JSON format. Check out the <code>isDefault</code> field in the JSON. For instance, mine had "Pay as you go" as the default (which I don&#8217;t want, because I have plenty of credit on my MSDN account).</p>
</div>
<div class="paragraph">
<p>If you want to change the default, enter a command like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>az account set --subscription "Visual Studio Ultimate with MSDN"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the subscription name (as I did) or the ID.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_azure_cli">Azure-cli</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The above two commands that used "az" are using the "Azure CLI". You can install this on your local machine, and it comes out-of-the-box when using the Cloud Shell.</p>
</div>
<div class="paragraph">
<p>Before we can create a Kubernetes cluster with a Couchbase cluster, let&#8217;s use azure-cli to lay the groundwork.</p>
</div>
<div class="paragraph">
<p>First, create a resource group. A resource group is a logical grouping that you can use to organize the various services and instances in Azure. You can get a list of all your current resource groups with this command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>az group list</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create a new resource group in a number of ways, but here&#8217;s how you can do it from the command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>az group create --name cb_aks_spike --location eastus</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, the resource group should appear when you run <code>az group list</code>, or when you view your resource groups in the normal Azure Portal UI.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re trying to use your local Windows PowerShell, you might also need to take the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check to see if you have the ContainerService registered. You can find out by running <code>az provider list | ConvertFrom-Json | Format-Wide</code> and seeing if it&#8217;s listed there.</p>
</li>
<li>
<p>If it&#8217;s not listed, start ContainerService registration: <code>az provider register -n Microsoft.ContainerService</code></p>
</li>
<li>
<p>Then, monitor the progress of ContainerService registration: <code>az provider show -n Microsoft.ContainerService</code> (wait until "registrationState" is not "Registering" and becomes "Registered")</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These steps might not be necessary when AKS goes out of preview into a general release.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_aks_cluster">Create AKS cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next, create an AKS cluster inside of the resource group you created in the previous section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>az aks create --resource-group cb_aks_spike --name cbAKScluster --generate-ssh-keys</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>(AKS cluster name can only contain letter, numbers, and dashes).</em></p>
</div>
<div class="paragraph">
<p>This will take some time to complete. When it&#8217;s done, you&#8217;ll have a managed container service with:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A node pool of size 3 (the default, you can specify with --node-count)</p>
</li>
<li>
<p>Each node is a DS1_v2 Azure instance (Single CPU, 3.5gb RAM machines, which are inexpensive and fine for this demo, but you will probably want to use a more powerful machine for Couchbase in production)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that you&#8217;ve created a <strong>Kubernetes cluster</strong>. Next, we&#8217;ll install a <strong>Couchbase cluster</strong> <em>within</em> the Kubernetes cluster. It&#8217;s important to keep track of and communicate the specific cluster whenever you refer to one.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_kubectl_to_put_couchbase_on_aks">Use kubectl to put Couchbase on AKS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This next part will run locally on PowerShell, and not in the Azure Cloud Shell. You will need to be logged in and have <a href="https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli">Azure-cli already installed</a> along with <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubectl</a> (which you probably have already).</p>
</div>
<div class="paragraph">
<p>Then, install the AKS cli locally with this command: <code>az aks install-cli</code>.</p>
</div>
<div class="paragraph">
<p>After that, you&#8217;ll need to connect to the AKS cluster created earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>az aks get-credentials --resource-group=cb_aks_spike --name=cbAKScluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once that succeeds, you can use kubectl to get a list of the 3 nodes created earlier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>kubectl get nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of that command should look like:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10604-kubectl-get-nodes.png" alt="Kubectl get nodes" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>Couchbase has introduced a <a href="https://blog.couchbase.com/introducing-couchbase-operator/">Kubernetes operator</a>, which is currently in beta. You don&#8217;t <em>have</em> to use this operator, but it&#8217;s going to make using Couchbase on Kubernetes a much better experience.</p>
</div>
<div class="paragraph">
<p>Start by deploying the operator with <code>kubectl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>kubectl create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/operator.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10608-create-operator.png" alt="Create operator" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>When that&#8217;s finished, you can view all deployments with <code>kubectl get deployments</code>.</p>
</div>
<div class="paragraph">
<p>Now it&#8217;s time to deploy Couchbase. You&#8217;ll need to create a secret and a cluster, both with YAML files. You can use a couple of sample YAML files available at these URLs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>kubectl create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/secret.yaml
kubectl create -f https://s3.amazonaws.com/packages.couchbase.com/kubernetes/beta/couchbase-cluster.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, you can <a href="http://docs.couchbase.com/prerelease/couchbase-operator/beta/couchbaseClusterConfig.html">create your own YAML cluster configuration</a>.</p>
</div>
<div class="paragraph">
<p>I created my own minor variation on this sample, adjusting the memory quota, the services, and the bucket name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code class="language-YAML" data-lang="YAML">apiVersion: couchbase.database.couchbase.com/v1beta1
kind: CouchbaseCluster
metadata:
  name: cb-example
spec:
  baseImage: couchbase/server
  version: enterprise-5.0.1
  authSecret: cb-example-auth
  exposeAdminConsole: true
  cluster:
    dataServiceMemoryQuota: 512
    indexServiceMemoryQuota: 256
    searchServiceMemoryQuota: 256
    indexStorageSetting: memory_optimized
    autoFailoverTimeout: 30
  buckets:
    - name: myBucket
      type: couchbase
      memoryQuota: 128
      replicas: 2
      ioPriority: high
      evictionPolicy: valueOnly
      conflictResolution: seqno
      enableFlush: true
      enableIndexReplica: false
  servers:
    - size: 3
      name: all_services
      services:
        - data
        - index
        - query
      dataPath: /opt/couchbase/var/lib/couchbase/data
      indexPath: /opt/couchbase/var/lib/couchbase/data</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point, AKS will start creating the "pods". You can check out the status with: <code>kubectl get pods</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10606-get-pods.png" alt="get pods" class="img-responsive"></span>
<span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10605-kubectl-get-pods.png" alt="kubectl get pods running on AKS" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>This will take a few minutes to complete.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_the_aks_cluster">Access the AKS cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Couchbase cluster is now running in the Kubernetes cluster. One other way you can access Couchbase, just to verify it&#8217;s working, is with port forwarding. Run this command locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code>kubectl port-forward cb-example-0000 8091:8091</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you do this, you&#8217;re forwarding localhost on port 8091 to the cb-example-0000 pod on port 8091. Which means that if you open <a href="http://localhost:8091" class="bare">http://localhost:8091</a> in your local browser, you&#8217;ll be directed to the Couchbase cluster running in AKS on Azure.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="https://crosscuttingconcerns.blob.core.windows.net/images/10607-couchbase-cluster.png" alt="Couchbase cluster" class="img-responsive"></span></p>
</div>
<div class="paragraph">
<p>An easy way to see AKS and the Kubernetes operator in action is to remove the bucket. The Couchbase operator will notice this, and recreate the bucket automatically.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now you&#8217;ve got your feet wet with Couchbase and AKS on Azure. Here are some more resources to continue your journey:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Couchbase Operator with AKS guide from the <a href="https://github.com/couchbase-partners/azure-kubernetes-couchbase">Couchbase Partners team</a>.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli">Getting started with Azure-cli</a> from the Microsoft docs team.</p>
</li>
<li>
<p><a href="http://docs.couchbase.com/prerelease/couchbase-operator/beta/overview.html">Couchbase Kubernetes operator</a> documentation</p>
</li>
<li>
<p>Questions? Head over the <a href="https://forums.couchbase.com/c/couchbase-server">Couchbase Server forums</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Questions or comments for me? You can find me on <a href="https://twitter.com/mgroves">Twitter @mgroves</a>.</p>
</div>
</div>
</div>
