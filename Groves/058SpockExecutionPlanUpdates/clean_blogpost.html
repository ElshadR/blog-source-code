
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In March&#8217;s developer build, there are some more updates for N1QL query monitoring and profiling.</p>
</div>
<div class="paragraph">
<p>Go <a href="https://couchbase.com/downloads">download the March 5.0.0 developer release of Couchbase Server</a> today. Make sure to click the "Developer" tab to get the developer build (DB), and check it out. You still have time to give us some feedback before the official release.</p>
</div>
<div class="paragraph">
<p>In case you missed it, check out the <a href="https://blog.couchbase.com/new-profiling-monitoring-couchbase-server-4-6/">post I wrote in February</a> about the New Profiling and Monitoring in Couchbase Server 5.0 Preview, as this post very much builds on that.</p>
</div>
<div class="paragraph">
<p><em>As before, keep in mind that I&#8217;m writing this blog post on early builds, and some things may change in minor ways by the time you get the release.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_workbench">Query Workbench</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once again, I&#8217;ll be focusing on <a href="https://developer.couchbase.com/documentation/server/current/tools/query-workbench.html">Query Workbench</a> for this blog post. The updates for March are mainly visual changes to the "Plan" view in Query Results.</p>
</div>
<div class="paragraph">
<p>But just to review, there are other options for running N1QL queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <a href="https://developer.couchbase.com/documentation/server/current/sdk/dotnet/n1ql-queries-with-sdk.html">SDK of your choice</a>.</p>
</li>
<li>
<p><a href="https://developer.couchbase.com/documentation/server/current/cli/cbq-tool.html">cbq command line tool</a>.</p>
</li>
<li>
<p><a href="https://developer.couchbase.com/documentation/server/current/n1ql/n1ql-rest-api/index.html">REST API N1QL endpoints</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Personally, I find the Query Workbench easiest to use, as it more visually presents the profiling.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_profiling_complex_queries">Profiling complex queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s look at the <code>travel-sample</code> data again, just like I did in last month&#8217;s post. I&#8217;m using the travel-sample bucket, but I have removed one of the indexes (<code>DROP INDEX `travel-sample</code>.<code>def_sourceairport</code>;`).</p>
</div>
<div class="paragraph">
<p>I then execute a N1QL query to find routes between two cities. Let&#8217;s use Columbus, Ohio and Denver, Colorado this time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight decode:true"><code class="language-SQL" data-lang="SQL">SELECT r.id, a.name, s.flight, s.utc, r.sourceairport, r.destinationairport, r.equipment
FROM `travel-sample` r
UNNEST r.schedule s
JOIN `travel-sample` a ON KEYS r.airlineid
WHERE r.sourceairport = 'CMH'
AND r.destinationairport = 'DEN'
AND s.day = 0
ORDER BY a.name;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Executing this query (on my single-node local machine) took about 8 seconds this time (as expected), which is too slow.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_visual_breakdown_of_profiling">Visual Breakdown of Profiling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s look at the plan to see what the problem might be (I broke it into two lines so the screenshots will fit in the blog post).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/058-01-Profiling-Execution-Plan-Part-1.png" alt="Visual profiling part 1"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/058-02-Profiling-Execution-Plan-Part-2.png" alt="Visual profiling part 2"></span></p>
</div>
<div class="paragraph">
<p>So, as before, the costliest parts of the query plan are the Filter and the Join. We could tell before by looking at the raw numbers and/or the percentages. But in this March release, we have a more visual way to tell: color. The parts of the plan go from gray to tan to gold based on percentages and defined thresholds.</p>
</div>
<div class="paragraph">
<p>Right now, the thresholds are based on the fraction of the total query time taken by an operation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gray â€“ less than 1% of total time</p>
</li>
<li>
<p>Tan/Some gold â€“ 1% - 5%</p>
</li>
<li>
<p>Tan/More gold â€“ 5% - 20%</p>
</li>
<li>
<p>All gold - &gt; 20%</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The purpose of this visual profiling is to quickly draw your eye to expensive operations. Then, if you care to know the exact numbers, you can read it in the details (in the diagram or even in the <code>META().plan</code> information).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_we_still_want_your_feedback">We still want your feedback!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Stay tuned to the <a href="http://blog.couchbase.com">Couchbase Blog</a> for information about what&#8217;s coming in the next developer build.</p>
</div>
<div class="paragraph">
<p>Interested in trying out some of these new features? <a href="https://couchbase.com/download">Download Couchbase Server 5.0</a> today!</p>
</div>
<div class="paragraph">
<p>We want feedback! Developer releases are coming every month, so you have a chance to make a difference in what we are building.</p>
</div>
<div class="paragraph">
<p>Do you like this new use of color to help you profile your queries? Now you can give feedback directly from within the Couchbase Web Console. Look for the feedback icon] icon at the bottom right of the screen.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/058-03-Feedback-Form.gif" alt="Send feedback from within Couchbase"></span></p>
</div>
<div class="paragraph">
<p>Is something not working right? Please file an issue in our <a href="https://issues.couchbase.com">JIRA system at issues.couchbase.com</a> or submit a question on the <a href="https://forums.couchbase.com">Couchbase Forums</a>. Or, contact me with a description of the issue. I would be happy to help you or submit the bug for you (my Couchbase handlers let me have a free Kit-Kat for each good bug I submit).</p>
</div>
<div class="paragraph">
<p>If you have questions, the best way to contact me is either <a href="https://twitter.com/mgroves">Twitter @mgroves</a> or email me <a href="mailto:matthew.groves@couchbase.com">matthew.groves@couchbase.com</a>.</p>
</div>
</div>
</div>
